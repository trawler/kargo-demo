{{ if eq .Values.global.argoApp.environment "kargo-test" }}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: control-clusters
  namespace: {{ .Release.Namespace }}
  labels:
    app.kubernetes.io/part-of: argocd
    app.kubernetes.io/instance: argocd-cd
spec:
  generators:
    - matrix:
        generators:
        - list:
            elements:
              - cluster: prod-control
                server: https://172.20.0.15:6443
                environment: prod
                clusterType: control
                nodesCidr: 172.20.0.0/16
                apiserver: https://172.20.0.15:6443
                apiserverIp: 172.20.0.15
              - cluster: stage-control
                server: https://172.20.0.5:6443
                environment: stage
                clusterType: control
                nodesCidr: 172.20.0.0/16
                apiserver: https://172.20.0.5:6443
                apiserverIp: 172.20.0.5
        - list:
            elements:
              - appName: argo-cd-applicationsets
                appRevision: main
              - appName: cert-manager
                appRevision: main
  goTemplate: true
  goTemplateOptions:
  - missingkey=error
  template:
    metadata:
      name: '{{ "{{" }}.appName{{ "}}" }}-{{ "{{" }}.cluster{{ "}}" }}'
      annotations:
        kargo.akuity.io/authorized-stage: msvc-system:{{ "{{" }}.environment{{ "}}" }}
    spec:
      destination:
        server: '{{ "{{" }}.server{{ "}}" }}'
        namespace: argocd
      project: 'msvc-system'
      source:
        path: apps/{{ "{{" }}.appName{{ "}}" }}
        repoURL: https://github.com/trawler/kargo-demo.git
        targetRevision: '{{ "{{" }}.appRevision{{ "}}" }}'
        helm:
          parameters:
            - name: argoApp.name
              value: '{{ "{{" }}.appName{{ "}}" }}-{{ "{{" }}.cluster{{ "}}" }}'
            - name: argoApp.project
              value: 'msvc-system'
            - name: argoApp.cluster
              value: '{{ "{{" }}.cluster{{ "}}" }}'
            - name: argoApp.server
              value: '{{ "{{" }}.server{{ "}}" }}'
            - name: argoApp.path
              value: '{{ "{{" }}.appName{{ "}}" }}'
            - name: argoApp.revision
              value: '{{ "{{" }}.appRevision{{ "}}" }}'
            - name: argoApp.namespace
              value: 'argocd'
            - name: argoApp.environment
              value: '{{ "{{" }}.environment{{ "}}" }}'
            - name: argoApp.nodes.cidr
              value: '{{ "{{" }}.nodesCidr{{ "}}" }}'
            - name: argoApp.clusterType
              value: '{{ "{{" }}.clusterType{{ "}}" }}'
            - name: argoApp.apiserver.cidr
              value: '{{ "{{" }}.apiserverIp{{ "}}" }}'
            - name: argoApp.apiserver.server
              value: '{{ "{{" }}.apiserver{{ "}}" }}'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - Replace=true
{{ end }}
