{{- if and .Values.kargo.stages.enabled .Values.kargo.project.enabled }}
{{- if eq .Values.global.argoApp.environment "stage" }}
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: stage
  namespace: {{ .Values.kargo.project.name }}
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: {{ .Values.kargo.warehouse.name }}
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: repoURL
          value: {{ .Values.kargo.warehouse.repoURL }}
      steps:
        # TODO: Create PromotionTask for complex logic:
        # - Parse commit message to detect updated apps (convention-based)
        # - Extract version from Chart.yaml for each app
        # - Create tags for each updated app
        # For now, this is a placeholder that needs PromotionTask implementation
        - task:
            name: create-app-tags
            kind: PromotionTask
{{- end }}
{{- if eq .Values.global.argoApp.environment "prod" }}
---
apiVersion: kargo.akuity.io/v1alpha1
kind: Stage
metadata:
  name: prod
  namespace: {{ .Values.kargo.project.name }}
spec:
  requestedFreight:
    - origin:
        kind: Warehouse
        name: {{ .Values.kargo.warehouse.name }}
      sources:
        direct: true
  promotionTemplate:
    spec:
      vars:
        - name: repoURL
          value: {{ .Values.kargo.warehouse.repoURL }}
      steps:
        # TODO: Create PromotionTask for complex logic:
        # - Parse tag name to extract app name
        # - Update ApplicationSet files with new tag
        # - Commit and push changes
        # For now, this is a placeholder that needs PromotionTask implementation
        - task:
            name: update-applicationset
            kind: PromotionTask
{{- end }}
{{- end }}


